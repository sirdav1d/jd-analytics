generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                 String              @id @default(uuid())
  name               String
  googleAccessToken  String?
  googleRefreshToken String?
  googleScopes       String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  googleExpiresAt    BigInt?
  external_code      Int                 @unique @default(autoincrement()) @db.SmallInt
  dashboardComercial DashboardComercial?
  Pedido             Pedido[]
}

model User {
  id         String      @id @default(uuid())
  name       String
  email      String      @unique
  password   String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  role       Role
  externalId String      @unique
  Pedidos    Pedido[]
  SalesGoal  SalesGoal[]
}

model Customer {
  id           String     @id @default(uuid())
  name         String
  personType   PersonType @map("person_type")
  externalCode Int?       @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  sales        Pedido[]
}

model SalesGoal {
  id          String   @id @default(uuid())
  userId      String
  goalDateRef DateTime @db.Date
  revenue     Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  seller      User     @relation(fields: [userId], references: [id])

  @@unique([userId, goalDateRef])
}

model PaymentMethod {
  id        String   @id @default(uuid())
  method    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sales     Pedido[]
}

model SaleItem {
  id         String   @id @default(uuid())
  quantity   Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  productId  String   @map("product_id")
  saleId     String   @map("sale_id")
  totalValue Float    @map("total_value")
  unitValue  Float    @map("unit_value")
  product    Product  @relation(fields: [productId], references: [id])
  sale       Pedido   @relation(fields: [saleId], references: [id], onDelete: Cascade)
}

model Product {
  id           String     @id @default(uuid())
  description  String
  brand        String
  sector       String
  externalCode Int?       @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  items        SaleItem[]
}

model Pedido {
  id              String         @id @default(uuid())
  data_pedido     DateTime       @db.Date
  natureOperation String
  operationType   String
  documentNumber  String
  origin          String
  cancelled       Boolean        @default(false)
  userId          String
  customerId      String?
  paymentMethodId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  organizationId  String
  customer        Customer?      @relation(fields: [customerId], references: [id])
  organization    Organization   @relation(fields: [organizationId], references: [id])
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
  items           SaleItem[]

  @@unique([documentNumber, organizationId, data_pedido])
}

model DashboardComercial {
  id                      String       @id @default(uuid())
  organizationId          String       @unique
  receitaTotal            Decimal
  ticketMedio             Decimal
  crescimentoReceita      Float
  novosClientes           Int
  taxaRetencaoClientes    Float
  clv                     Decimal
  volumeReparos           Int
  taxaReincidenciaReparos Float
  receitaReparosVsVendas  Float
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  SELLER
}

enum PersonType {
  FISICA
  JURIDICA
}
