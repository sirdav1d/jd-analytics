generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                 String              @id @default(uuid())
  name               String
  googleAccessToken  String?
  googleRefreshToken String?
  googleScopes       String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  googleExpiresAt    BigInt?
  dashboardComercial DashboardComercial?
  dashboardMarketing DashboardMarketing?
  users              User[]
}

model User {
  id             String       @id @default(uuid())
  externalId     String       @unique
  name           String
  email          String       @unique
  password       String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  role           Role
  organization   Organization @relation(fields: [organizationId], references: [id])
  Pedidos        Pedido[]
  SalesGoal      SalesGoal[]
}

model Customer {
  id           String     @id @default(uuid())
  name         String
  personType   PersonType // Física ou Jurídica
  externalCode Int?       @unique // Código Cliente, se disponível
  sales        Pedido[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SalesGoal {
  id          String   @id @default(uuid())
  seller      User     @relation(fields: [userId], references: [id])
  userId      String
  goalDateRef DateTime @db.Date // sempre o primeiro dia do mês
  revenue     Float // meta de faturamento
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, goalDateRef])
}

model PaymentMethod {
  id     String   @id @default(uuid())
  method String   @unique
  sales  Pedido[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleItem {
  id         String  @id @default(uuid())
  sale       Pedido  @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId     String  @map("sale_id")
  product    Product @relation(fields: [productId], references: [id])
  productId  String  @map("product_id")
  quantity   Float // Qtde Item
  unitValue  Float   @map("unit_value") // Valor Unitário Item
  totalValue Float   @map("total_value") // Valor Total Item

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id           String     @id @default(uuid())
  description  String
  brand        String // marca como atributo simples
  sector       String // setor do produto
  externalCode Int?       @unique // Código Produto, se disponível
  items        SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pedido {
  id              String   @id @default(uuid())
  data_pedido     DateTime
  natureOperation String // Natureza de Operação (ex: [S] VENDA DE PRODUTOS)
  operationType   String // Operação (ex: S - Venda)
  documentNumber  String   @unique // Documento 
  origin          String // Origem da venda
  cancelled       Boolean  @default(false) // Cancelada (true/false)

  user            User           @relation(fields: [userId], references: [id])
  userId          String
  customer        Customer?      @relation(fields: [customerId], references: [id])
  customerId      String?
  items           SaleItem[]
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model DashboardMarketing {
  id                   String             @id @default(uuid())
  organizationId       String             @unique
  sessoes              Int
  usuarios             Int
  taxaRejeicao         Float
  taxaConversaoSite    Float
  taxaAbandonoCarrinho Float
  impressoes           Int
  cliques              Int
  ctr                  Float
  cpc                  Decimal
  conversoes           Int
  custoPorConversao    Decimal
  roas                 Float
  custoPorLead         Decimal
  faturamentoTotal     Decimal
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  anunciosCTR          AnuncioCTR[]
  anunciosConv         AnuncioConversao[]
  canais               CanalTrafego[]
  organization         Organization       @relation(fields: [organizationId], references: [id])
  palavrasChave        PalavraChave[]
  trafego              Trafego[]
}

model Trafego {
  id          String             @id @default(uuid())
  dashboardId String
  origem      String
  valor       Int
  dashboard   DashboardMarketing @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

model CanalTrafego {
  id            String             @id @default(uuid())
  dashboardId   String
  canal         String
  taxaConversao Float
  cpa           Decimal
  roi           Float
  dashboard     DashboardMarketing @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

model AnuncioCTR {
  id          String             @id @default(uuid())
  dashboardId String
  nome        String
  ctr         Float
  dashboard   DashboardMarketing @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

model AnuncioConversao {
  id          String             @id @default(uuid())
  dashboardId String
  nome        String
  conversoes  Int
  dashboard   DashboardMarketing @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

model PalavraChave {
  id          String             @id @default(uuid())
  dashboardId String
  palavra     String
  ctr         Float
  dashboard   DashboardMarketing @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

model DashboardComercial {
  id                      String   @id @default(uuid())
  organizationId          String   @unique
  receitaTotal            Decimal
  ticketMedio             Decimal
  crescimentoReceita      Float
  novosClientes           Int
  taxaRetencaoClientes    Float
  clv                     Decimal
  volumeReparos           Int
  taxaReincidenciaReparos Float
  receitaReparosVsVendas  Float
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  SELLER
}

enum PersonType {
  FISICA
  JURIDICA
}
